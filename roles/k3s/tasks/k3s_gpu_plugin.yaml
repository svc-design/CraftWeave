- name: Install NVIDIA device plugin Helm chart
  shell: |
    helm repo add nvidia-device-plugin https://nvidia.github.io/k8s-device-plugin
    helm repo update
    helm install nvidia-device-plugin nvidia-device-plugin/nvidia-device-plugin --set runtimeClassName=nvidia --namespace kube-system

- name: Verify RuntimeClass and Pod
  k8s:
    state: present
    definition:
      apiVersion: node.k8s.io/v1
      kind: RuntimeClass
      metadata:
        name: nvidia
      handler: nvidia
  register: runtime_class_result

- name: Verify Pod with NVIDIA GPU
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: nbody-gpu-benchmark
        namespace: default
      spec:
        restartPolicy: OnFailure
        runtimeClassName: nvidia
        tolerations:
          - key: nvidia.com/gpu  
            operator: Exists
            effect: NoSchedule
        containers:
          - name: cuda-container
            image: nvcr.io/nvidia/k8s/cuda-sample:nbody-cuda11.2.1
            args: ["nbody", "-gpu", "-benchmark"]
            resources:
              limits:
                nvidia.com/gpu: 1
            env:
              - name: NVIDIA_VISIBLE_DEVICES
                value: all
              - name: NVIDIA_DRIVER_CAPABILITIES
                value: all
  register: pod_result

- name: Output results
  debug:
    msg: "{{ item }}"
  loop:
    - "{{ runtime_class_result }}"
    - "{{ pod_result }}"
