---
# post-setup.yml

- name: 启动 Docker Compose 服务
  become: true
  command: docker-compose -f /home/ubuntu/docker-compose.yml up -d

- name: 检查 Keycloak 容器是否运行
  command: docker ps -q -f name={{ keycloak_name }}
  register: keycloak_container
  changed_when: false
  failed_when: keycloak_container.stdout == ""

- name: 确保 Keycloak 容器正在运行
  debug:
    msg: "Keycloak 容器正在运行"
  when: keycloak_container.stdout != ""

- name: 检查 PostgreSQL 容器是否运行
  command: docker ps -q -f name={{ postgres_name }}
  register: postgres_container
  changed_when: false
  failed_when: postgres_container.stdout == ""

- name: 确保 PostgreSQL 容器正在运行
  debug:
    msg: "PostgreSQL 容器正在运行"
  when: postgres_container.stdout != ""

- name: 检查 Nginx 容器是否运行
  command: docker ps -q -f name={{ nginx_name }}
  register: nginx_container
  changed_when: false
  failed_when: nginx_container.stdout == ""

- name: 确保 Nginx 容器正在运行
  debug:
    msg: "Nginx 容器正在运行"
  when: nginx_container.stdout != ""

- name: 如果 Keycloak 容器未运行，则重新启动 Keycloak
  become: true
  command: docker-compose -f /home/ubuntu/docker-compose.yml up -d keycloak
  when: keycloak_container.stdout == ""

- name: 如果 PostgreSQL 容器未运行，则重新启动 PostgreSQL
  become: true
  command: docker-compose -f /home/ubuntu/docker-compose.yml up -d postgres
  when: postgres_container.stdout == ""

- name: 如果 Nginx 容器未运行，则重新启动 Nginx
  become: true
  command: docker-compose -f /home/ubuntu/docker-compose.yml up -d nginx
  when: nginx_container.stdout == ""

- name: 检查并显示 Keycloak、PostgreSQL 和 Nginx 容器的状态
  become: true
  command: docker-compose -f /home/ubuntu/docker-compose.yml ps
  register: docker_ps_status
  changed_when: false

- name: 输出 Docker Compose 容器状态
  debug:
    msg: "{{ docker_ps_status.stdout }}"
